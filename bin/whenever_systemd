#!/usr/bin/env ruby

require 'optparse'
require 'whenever_systemd'
require 'whenever_systemd/version'

options = {}

OptionParser.new do |opts|
  opts.banner = "Usage: whenever [options]"

  opts.on('-p', '--prefix [unit prefix]', 'Unit prefix') do |prefix|
    options[:prefix] = prefix
  end

  opts.on('-d', '--dir [install path]',
          'Unit Search Path',
          "  Default: #{WheneverSystemd::DEFAULT_INSTALL_PATH}") do |path|
    options[:install_path] = path
  end

  opts.on('-i', '--update-units [schedule]',
          'Install the schedule units.',
          '  Default: full path to schedule.rb file') do |identifier|
    options[:update] = true
    options[:identifier] = identifier if identifier
  end

  opts.on('-c', '--clear-units [schedule]',
          'Uninstall units',
          '  Default: full path to schedule.rb file') do |identifier|
    options[:clear] = true
    options[:identifier] = identifier if identifier
  end

  opts.on('-s', '--set [variables]', 'Example: --set \'environment=staging&path=/my/sweet/path\'') do |set|
    options[:set] = set if set
  end

  opts.on('-f', '--load-file [schedule file]', 'Default: config/schedule.rb') do |file|
    options[:file] = file if file
  end

  opts.on('-u', '--user [user]', 'Default: current user') do |user|
    options[:user] = user if user
  end

  opts.on('-r', '--roles [role1,role2]', 'Comma-separated list of server roles to generate cron jobs for') do |roles|
    options[:roles] = roles.split(',').map(&:to_sym) if roles
  end

  opts.on('-S', '--dry-run', 'Only print script which will be executed') do |c|
    options[:dry] = true
  end

  opts.on("--sudo", "Use sudo with operations") do
    options[:sudo] = true
  end

  opts.on('-v', '--version') { puts "WheneverSystemd v#{WheneverSystemd::VERSION}"; exit(0) }
end.parse!

WheneverSystemd::CommandLine.execute(options)
